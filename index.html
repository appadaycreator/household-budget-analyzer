<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ« - ç„¡æ–™ã§å®¶è¨ˆã®ç„¡é§„ã‚’ç™ºè¦‹</title>
    <meta name="description" content="å®¶è¨ˆã®åæ”¯ã‚’åˆ†æã—ã€ç„¡é§„é£ã„ã‚’æ¤œå‡ºã—ã¦ç¯€ç´„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’è¨ˆç®—ã™ã‚‹ç„¡æ–™ã®å®¶è¨ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ã€‚çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒã€ã‚°ãƒ©ãƒ•å¯è¦–åŒ–æ©Ÿèƒ½ä»˜ãã€‚">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWuteiojOiwruaWreODhOODvOODqyIsCiAgInNob3J0X25hbWUiOiAi5a616KiO6LCu5patIiwKICAiZGVzY3JpcHRpb24iOiAi5a616KiO44Gu5pS25pSv44KS5YiG5p6Q44GX44CB54Sh6aeE6YG/44GE44KS5qSc5Ye644GX44Gm56+A57SE44Od44OG44Oz44K344Oj44Or44KS6KiI566X44GZ44KL54Sh5paZ44Gu5a616KiO6LCu5pat44OE44O844OrIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzIwNjNlYiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1UY3lJaUJvWldsbmFIUTlJakUzTWlJZ2RtbGxkMEp2ZUQwaU1DQXdJREUzTWlBeE56SWlJR1pwYkd3OUltNXZibVVpSUhOMGNtOXJaVDBpSXpJd05qTmxZaUlnYzNSeWIydGxMWGRwWkhSb1BTSXpJaUJzYVc1bFFreGphVzVsUFNKeWIzVnVaQ0lnZUcxc2JuTTlJbWgwZEhBNkx5OTNkM2N1ZHpNdWIzSm5Mekl3TURBdmMzWm5JajQ4Y0dGMGFDQmtQU0pOT0RVdU5USWdORFV1TkRSRE9EY3VNRGNnTkRNdU5EZGNPRGt1TXpjZ05ESXVPVFJjT1RFdU56Y2dORFF1TVRnZ09UUXVOekVnTkRjdU5ERWdPVFl1TmprZ05UQXVPRFJnTlM0eU5pQjJOak11TnpOakxUSTVMalkyTFRJNUxqWTJMVE13TFMweE5DNHdOMDA0TlM0MU1pQTBOUzQwTkVvNU9DNDBOeUV6TURFdU1ESWdNakV6TGprNElETTJNaTQzTkNBek5qSXVOelJUTWprMUxqazNJRFUzTkM0M055QXlPVFV1T1RjZ05UYzBMamMzZWkwaU1DOXdZWFJvUGp3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjE3MngxNzIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .comparison-chart {
            height: 300px;
        }
        @media print {
            body { font-size: 12px; }
            .no-print { display: none; }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .input-focus:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-12 fade-in-up">
            <div class="gradient-bg text-white p-8 rounded-xl card-shadow">
                <h1 class="text-4xl font-bold mb-4">
                    <i class="fas fa-chart-pie mr-3"></i>å®¶è¨ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«
                </h1>
                <p class="text-xl opacity-90">å®¶è¨ˆã®ç„¡é§„ã‚’è¦‹ãˆã‚‹åŒ–ã—ã€ç¯€ç´„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’ç™ºè¦‹</p>
                <p class="text-sm mt-2 opacity-80">åæ”¯ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§æ”¹å–„ãƒã‚¤ãƒ³ãƒˆã¨ç¯€ç´„é¡ãŒä¸€ç›®ç­ç„¶</p>
            </div>
        </header>

        <!-- Input Form -->
        <section id="input-section" class="mb-12 fade-in-up">
            <div class="bg-white rounded-xl p-8 card-shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-edit text-blue-600 mr-3"></i>å®¶è¨ˆæƒ…å ±å…¥åŠ›
                </h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">åŸºæœ¬æƒ…å ±</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">æœˆåï¼ˆæ‰‹å–ã‚Šï¼‰</label>
                                <input type="number" id="income" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 350000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">å®¶æ—æ§‹æˆ</label>
                                <select id="familyType" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200">
                                    <option value="single">å˜èº«</option>
                                    <option value="couple">å¤«å©¦ã®ã¿</option>
                                    <option value="family2">å¤«å©¦+å­ä¾›1äºº</option>
                                    <option value="family3">å¤«å©¦+å­ä¾›2äºº</option>
                                    <option value="family4">å¤«å©¦+å­ä¾›3äººä»¥ä¸Š</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">å±…ä½åœ°åŸŸ</label>
                                <select id="region" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200">
                                    <option value="tokyo">æ±äº¬éƒ½</option>
                                    <option value="osaka">å¤§é˜ªåºœ</option>
                                    <option value="aichi">æ„›çŸ¥çœŒ</option>
                                    <option value="kanagawa">ç¥å¥ˆå·çœŒ</option>
                                    <option value="other">ãã®ä»–</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- æ”¯å‡ºé …ç›® -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">æœˆé–“æ”¯å‡º</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">ä½å±…è²»</label>
                                <input type="number" id="housing" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 80000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">é£Ÿè²»</label>
                                <input type="number" id="food" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 60000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">æ°´é“å…‰ç†±è²»</label>
                                <input type="number" id="utilities" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 15000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">é€šä¿¡è²»</label>
                                <input type="number" id="communication" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 12000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">äº¤é€šè²»</label>
                                <input type="number" id="transport" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 8000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">å¨¯æ¥½è²»</label>
                                <input type="number" id="entertainment" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 30000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">ãã®ä»–</label>
                                <input type="number" id="others" class="w-full p-3 border border-gray-300 rounded-lg input-focus transition-all duration-200" placeholder="ä¾‹: 20000">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button onclick="analyzeBudget()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-lg transition-colors duration-200 transform hover:scale-105">
                        <i class="fas fa-calculator mr-2"></i>å®¶è¨ˆè¨ºæ–­ã‚’å®Ÿè¡Œ
                    </button>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="hidden">
            <!-- Summary Cards -->
            <div class="grid md:grid-cols-3 gap-6 mb-8 fade-in-up">
                <div class="bg-white rounded-xl p-6 card-shadow text-center">
                    <i class="fas fa-wallet text-3xl text-green-600 mb-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">åæ”¯ãƒãƒ©ãƒ³ã‚¹</h3>
                    <p id="balance" class="text-2xl font-bold mt-2"></p>
                </div>
                <div class="bg-white rounded-xl p-6 card-shadow text-center">
                    <i class="fas fa-piggy-bank text-3xl text-blue-600 mb-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">è²¯è“„ç‡</h3>
                    <p id="savingsRate" class="text-2xl font-bold mt-2"></p>
                </div>
                <div class="bg-white rounded-xl p-6 card-shadow text-center">
                    <i class="fas fa-chart-line text-3xl text-purple-600 mb-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">ç¯€ç´„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«</h3>
                    <p id="savingsPotential" class="text-2xl font-bold mt-2"></p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <!-- Current Budget Chart -->
                <div class="bg-white rounded-xl p-6 card-shadow fade-in-up">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-blue-600 mr-2"></i>ç¾åœ¨ã®å®¶è¨ˆæ§‹æˆ
                    </h3>
                    <div class="chart-container">
                        <canvas id="currentBudgetChart"></canvas>
                    </div>
                </div>

                <!-- Comparison Chart -->
                <div class="bg-white rounded-xl p-6 card-shadow fade-in-up">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-balance-scale text-green-600 mr-2"></i>ç†æƒ³ã¨ã®æ¯”è¼ƒ
                    </h3>
                    <div class="comparison-chart">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="bg-white rounded-xl p-8 card-shadow mb-8 fade-in-up">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-search text-orange-600 mr-3"></i>è©³ç´°åˆ†æãƒ»æ”¹å–„ææ¡ˆ
                </h3>
                <div id="detailedAnalysis" class="space-y-6"></div>
            </div>

            <!-- Action Plan -->
            <div class="bg-white rounded-xl p-8 card-shadow mb-8 fade-in-up">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-tasks text-indigo-600 mr-3"></i>å®Ÿè¡Œãƒ—ãƒ©ãƒ³
                </h3>
                <div id="actionPlan" class="space-y-4"></div>
            </div>

            <!-- SNS Share -->
            <div class="bg-white rounded-xl p-6 card-shadow mb-8 fade-in-up no-print">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-share-alt text-pink-600 mr-2"></i>çµæœã‚’ã‚·ã‚§ã‚¢
                </h3>
                <div class="flex flex-wrap gap-4">
                    <button onclick="shareToTwitter()" class="bg-blue-400 hover:bg-blue-500 text-white px-6 py-3 rounded-lg transition-colors duration-200">
                        <i class="fab fa-twitter mr-2"></i>Twitterã§ã‚·ã‚§ã‚¢
                    </button>
                    <button onclick="shareToLine()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors duration-200">
                        <i class="fab fa-line mr-2"></i>LINEã§ã‚·ã‚§ã‚¢
                    </button>
                    <button onclick="copyResults()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition-colors duration-200">
                        <i class="fas fa-copy mr-2"></i>çµæœã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="history-section" class="bg-white rounded-xl p-8 card-shadow mb-8 fade-in-up">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-history text-teal-600 mr-3"></i>è¨ºæ–­å±¥æ­´
            </h3>
            <div id="historyList" class="space-y-4">
                <p class="text-gray-500 text-center py-8">ã¾ã è¨ºæ–­å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-600 mt-12 fade-in-up">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <p class="mb-4">å®¶è¨ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ« - ã‚ãªãŸã®å®¶è¨ˆæ”¹å–„ã‚’ã‚µãƒãƒ¼ãƒˆ</p>
                <div class="flex justify-center space-x-6 text-sm">
                    <a href="#privacy" class="hover:text-blue-600 transition-colors">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                    <a href="#terms" class="hover:text-blue-600 transition-colors">åˆ©ç”¨è¦ç´„</a>
                    <a href="#contact" class="hover:text-blue-600 transition-colors">ãŠå•ã„åˆã‚ã›</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ç†æƒ³çš„ãªå®¶è¨ˆãƒãƒ©ãƒ³ã‚¹ï¼ˆç·å‹™çœçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
        const idealBudgetRatios = {
            single: {
                housing: 0.28,
                food: 0.15,
                utilities: 0.06,
                communication: 0.05,
                transport: 0.04,
                entertainment: 0.08,
                others: 0.14,
                savings: 0.20
            },
            couple: {
                housing: 0.25,
                food: 0.18,
                utilities: 0.07,
                communication: 0.05,
                transport: 0.05,
                entertainment: 0.10,
                others: 0.15,
                savings: 0.15
            },
            family2: {
                housing: 0.30,
                food: 0.20,
                utilities: 0.08,
                communication: 0.06,
                transport: 0.06,
                entertainment: 0.08,
                others: 0.17,
                savings: 0.05
            },
            family3: {
                housing: 0.28,
                food: 0.22,
                utilities: 0.09,
                communication: 0.06,
                transport: 0.07,
                entertainment: 0.06,
                others: 0.20,
                savings: 0.02
            },
            family4: {
                housing: 0.27,
                food: 0.25,
                utilities: 0.10,
                communication: 0.07,
                transport: 0.08,
                entertainment: 0.05,
                others: 0.18,
                savings: 0.00
            }
        };

        let currentAnalysis = null;
        let charts = {};

        function analyzeBudget() {
            const income = parseFloat(document.getElementById('income').value) || 0;
            const familyType = document.getElementById('familyType').value;
            const region = document.getElementById('region').value;
            
            const expenses = {
                housing: parseFloat(document.getElementById('housing').value) || 0,
                food: parseFloat(document.getElementById('food').value) || 0,
                utilities: parseFloat(document.getElementById('utilities').value) || 0,
                communication: parseFloat(document.getElementById('communication').value) || 0,
                transport: parseFloat(document.getElementById('transport').value) || 0,
                entertainment: parseFloat(document.getElementById('entertainment').value) || 0,
                others: parseFloat(document.getElementById('others').value) || 0
            };

            if (income <= 0) {
                alert('åå…¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + val, 0);
            const balance = income - totalExpenses;
            const savingsRate = (balance / income) * 100;
            
            const idealRatios = idealBudgetRatios[familyType];
            const analysis = performDetailedAnalysis(income, expenses, idealRatios, familyType, region);
            
            currentAnalysis = {
                income,
                expenses,
                balance,
                savingsRate,
                analysis,
                familyType,
                region,
                timestamp: new Date()
            };

            displayResults(currentAnalysis);
            saveToHistory(currentAnalysis);
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }

        function performDetailedAnalysis(income, expenses, idealRatios, familyType, region) {
            const analysis = {
                ratios: {},
                deviations: {},
                recommendations: [],
                savingsPotential: 0,
                riskAreas: []
            };

            // ç¾åœ¨ã®æ¯”ç‡è¨ˆç®—
            Object.keys(expenses).forEach(category => {
                analysis.ratios[category] = expenses[category] / income;
                analysis.deviations[category] = analysis.ratios[category] - idealRatios[category];
            });

            // ç¯€ç´„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«è¨ˆç®—
            let totalSavingsPotential = 0;
            Object.keys(expenses).forEach(category => {
                if (analysis.deviations[category] > 0.02) { // 2%ä»¥ä¸Šã®è¶…é
                    const savingsAmount = (analysis.deviations[category] - 0.01) * income;
                    totalSavingsPotential += savingsAmount;
                    analysis.riskAreas.push({
                        category,
                        excess: savingsAmount,
                        percentage: analysis.deviations[category] * 100
                    });
                }
            });

            analysis.savingsPotential = totalSavingsPotential;

            // å…·ä½“çš„ãªæ¨å¥¨äº‹é …
            generateRecommendations(analysis, expenses, income, familyType, region);

            return analysis;
        }

        function generateRecommendations(analysis, expenses, income, familyType, region) {
            const recommendations = [];

            // ä½å±…è²»ã®ãƒã‚§ãƒƒã‚¯
            if (analysis.deviations.housing > 0.05) {
                recommendations.push({
                    category: 'ä½å±…è²»',
                    priority: 'high',
                    suggestion: 'ä½å±…è²»ãŒåå…¥ã®é©æ­£æ¯”ç‡ã‚’å¤§ããè¶…ãˆã¦ã„ã¾ã™ã€‚å¼•ã£è¶Šã—ã‚„ãƒ­ãƒ¼ãƒ³ã®å€Ÿã‚Šæ›ãˆã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚',
                    potentialSaving: Math.floor((analysis.deviations.housing - 0.02) * income),
                    actionItems: ['å®¶è³ƒã®å®‰ã„ç‰©ä»¶ã¸ã®å¼•ã£è¶Šã—æ¤œè¨', 'ä½å®…ãƒ­ãƒ¼ãƒ³ã®å€Ÿã‚Šæ›ãˆæ¤œè¨', 'å›ºå®šè²»ã®è¦‹ç›´ã—']
                });
            }

            // é£Ÿè²»ã®ãƒã‚§ãƒƒã‚¯
            if (analysis.deviations.food > 0.03) {
                recommendations.push({
                    category: 'é£Ÿè²»',
                    priority: 'medium',
                    suggestion: 'é£Ÿè²»ã‚’è¦‹ç›´ã™ã“ã¨ã§å¤§ããªç¯€ç´„åŠ¹æœãŒæœŸå¾…ã§ãã¾ã™ã€‚',
                    potentialSaving: Math.floor((analysis.deviations.food - 0.01) * income),
                    actionItems: ['å¤–é£Ÿé »åº¦ã®è¦‹ç›´ã—', 'é£Ÿæã®è¨ˆç”»è³¼å…¥', 'å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªã®æ´»ç”¨']
                });
            }

            // é€šä¿¡è²»ã®ãƒã‚§ãƒƒã‚¯
            if (analysis.deviations.communication > 0.02) {
                recommendations.push({
                    category: 'é€šä¿¡è²»',
                    priority: 'high',
                    suggestion: 'é€šä¿¡è²»ã¯è¦‹ç›´ã—åŠ¹æœãŒé«˜ã„é …ç›®ã§ã™ã€‚æ ¼å®‰SIMã‚„ãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚',
                    potentialSaving: Math.floor((analysis.deviations.communication - 0.005) * income),
                    actionItems: ['æ ¼å®‰SIMã¸ã®å¤‰æ›´', 'ä¸è¦ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è§£ç´„', 'Wi-Fiç’°å¢ƒã®æ•´å‚™']
                });
            }

            // å¨¯æ¥½è²»ã®ãƒã‚§ãƒƒã‚¯
            if (analysis.deviations.entertainment > 0.05) {
                recommendations.push({
                    category: 'å¨¯æ¥½è²»',
                    priority: 'medium',
                    suggestion: 'å¨¯æ¥½è²»ã®è¦‹ç›´ã—ã§ç”Ÿæ´»ã®è³ªã‚’ä¿ã¡ãªãŒã‚‰ç¯€ç´„ã§ãã¾ã™ã€‚',
                    potentialSaving: Math.floor((analysis.deviations.entertainment - 0.02) * income),
                    actionItems: ['ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®æ•´ç†', 'ç„¡æ–™å¨±æ¥½ã®æ´»ç”¨', 'äºˆç®—è¨­å®šã®å¾¹åº•']
                });
            }

            // è²¯è“„ç‡ãŒä½ã„å ´åˆã®ææ¡ˆ
            const currentSavingsRate = ((income - Object.values(expenses).reduce((a, b) => a + b, 0)) / income) * 100;
            if (currentSavingsRate < 10) {
                recommendations.push({
                    category: 'è²¯è“„',
                    priority: 'high',
                    suggestion: 'è²¯è“„ç‡ãŒä½ã‚ã§ã™ã€‚å…ˆå–ã‚Šè²¯è“„ã®ä»•çµ„ã¿ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚',
                    potentialSaving: income * 0.1,
                    actionItems: ['è‡ªå‹•ç©ç«‹ã®è¨­å®š', 'å®¶è¨ˆç°¿ã§ã®æ”¯å‡ºç®¡ç†', 'å›ºå®šè²»ã®ç·åˆè¦‹ç›´ã—']
                });
            }

            analysis.recommendations = recommendations;
        }

        function displayResults(result) {
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const balanceElement = document.getElementById('balance');
            const savingsRateElement = document.getElementById('savingsRate');
            const savingsPotentialElement = document.getElementById('savingsPotential');

            balanceElement.textContent = `Â¥${result.balance.toLocaleString()}`;
            balanceElement.className = result.balance >= 0 ? 'text-2xl font-bold mt-2 text-green-600' : 'text-2xl font-bold mt-2 text-red-600';

            savingsRateElement.textContent = `${result.savingsRate.toFixed(1)}%`;
            savingsRateElement.className = result.savingsRate >= 10 ? 'text-2xl font-bold mt-2 text-blue-600' : 'text-2xl font-bold mt-2 text-orange-600';

            savingsPotentialElement.textContent = `Â¥${result.analysis.savingsPotential.toLocaleString()}`;
            savingsPotentialElement.className = 'text-2xl font-bold mt-2 text-purple-600';

            // ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
            displayCharts(result);

            // è©³ç´°åˆ†æè¡¨ç¤º
            displayDetailedAnalysis(result.analysis);

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³è¡¨ç¤º
            displayActionPlan(result.analysis.recommendations);
        }

        function displayCharts(result) {
            // ç¾åœ¨ã®å®¶è¨ˆæ§‹æˆãƒãƒ£ãƒ¼ãƒˆ
            const ctx1 = document.getElementById('currentBudgetChart').getContext('2d');
            if (charts.current) charts.current.destroy();
            
            const expenseData = Object.entries(result.expenses).map(([key, value]) => ({
                label: getCategoryName(key),
                value: value
            }));
            
            expenseData.push({
                label: 'è²¯è“„ãƒ»ä½™è£•',
                value: Math.max(0, result.balance)
            });

            charts.current = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: expenseData.map(item => item.label),
                    datasets: [{
                        data: expenseData.map(item => item.value),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label}: Â¥${data.datasets[0].data[i].toLocaleString()}`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        lineWidth: 0,
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        }
                    }
                }
            });

            // æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ
            const ctx2 = document.getElementById('comparisonChart').getContext('2d');
            if (charts.comparison) charts.comparison.destroy();

            const idealRatios = idealBudgetRatios[result.familyType];
            const categories = Object.keys(result.expenses);
            
            charts.comparison = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: categories.map(cat => getCategoryName(cat)),
                    datasets: [{
                        label: 'ç¾åœ¨ã®æ¯”ç‡ (%)',
                        data: categories.map(cat => ((result.expenses[cat] / result.income) * 100).toFixed(1)),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: 'ç†æƒ³ã®æ¯”ç‡ (%)',
                        data: categories.map(cat => (idealRatios[cat] * 100).toFixed(1)),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ¯”ç‡ (%)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function displayDetailedAnalysis(analysis) {
            const container = document.getElementById('detailedAnalysis');
            container.innerHTML = '';

            // ãƒªã‚¹ã‚¯ã‚¨ãƒªã‚¢ã®è¡¨ç¤º
            if (analysis.riskAreas.length > 0) {
                const riskSection = document.createElement('div');
                riskSection.className = 'bg-red-50 border-l-4 border-red-400 p-4 mb-6';
                riskSection.innerHTML = `
                    <h4 class="text-lg font-semibold text-red-800 mb-3">
                        <i class="fas fa-exclamation-triangle mr-2"></i>æ”¹å–„ãŒå¿…è¦ãªé …ç›®
                    </h4>
                    <div class="space-y-2">
                        ${analysis.riskAreas.map(area => `
                            <div class="flex justify-between items-center">
                                <span class="text-red-700">${getCategoryName(area.category)}</span>
                                <span class="text-red-600 font-semibold">
                                    +${area.percentage.toFixed(1)}% (Â¥${area.excess.toLocaleString()}è¶…é)
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(riskSection);
            }

            // æ¨å¥¨äº‹é …ã®è¡¨ç¤º
            analysis.recommendations.forEach(rec => {
                const recSection = document.createElement('div');
                const priorityColor = rec.priority === 'high' ? 'orange' : 'blue';
                recSection.className = `border-l-4 border-${priorityColor}-400 bg-${priorityColor}-50 p-4 mb-4`;
                recSection.innerHTML = `
                    <h4 class="text-lg font-semibold text-${priorityColor}-800 mb-2">
                        <i class="fas fa-lightbulb mr-2"></i>${rec.category}ã®æ”¹å–„ææ¡ˆ
                        <span class="text-sm bg-${priorityColor}-200 px-2 py-1 rounded ml-2">
                            å„ªå…ˆåº¦: ${rec.priority === 'high' ? 'é«˜' : 'ä¸­'}
                        </span>
                    </h4>
                    <p class="text-${priorityColor}-700 mb-3">${rec.suggestion}</p>
                    <p class="text-${priorityColor}-600 font-semibold mb-3">
                        <i class="fas fa-piggy-bank mr-1"></i>
                        ç¯€ç´„å¯èƒ½é¡: Â¥${rec.potentialSaving.toLocaleString()}/æœˆ
                    </p>
                    <div class="text-sm text-${priorityColor}-600">
                        <strong>å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong>
                        <ul class="list-disc list-inside mt-1 space-y-1">
                            ${rec.actionItems.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
                container.appendChild(recSection);
            });
        }

        function displayActionPlan(recommendations) {
            const container = document.getElementById('actionPlan');
            container.innerHTML = '';

            const plan = document.createElement('div');
            plan.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                    <h4 class="text-xl font-bold text-indigo-800 mb-4">
                        <i class="fas fa-rocket mr-2"></i>30æ—¥å®Ÿè¡Œãƒ—ãƒ©ãƒ³
                    </h4>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h5 class="font-semibold text-green-700 mb-2">
                                <i class="fas fa-calendar-week mr-1"></i>ç¬¬1é€±
                            </h5>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                                <li>â€¢ å›ºå®šè²»ã®æ´—ã„å‡ºã—</li>
                                <li>â€¢ ä¸è¦ãªã‚µãƒ–ã‚¹ã‚¯ã®ç¢ºèª</li>
                            </ul>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h5 class="font-semibold text-blue-700 mb-2">
                                <i class="fas fa-calendar-alt mr-1"></i>ç¬¬2-3é€±
                            </h5>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ é€šä¿¡è²»ãƒ—ãƒ©ãƒ³ã®è¦‹ç›´ã—</li>
                                <li>â€¢ é£Ÿè²»ã®äºˆç®—è¨­å®š</li>
                                <li>â€¢ é›»åŠ›ä¼šç¤¾ã®æ¯”è¼ƒæ¤œè¨</li>
                            </ul>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h5 class="font-semibold text-purple-700 mb-2">
                                <i class="fas fa-flag-checkered mr-1"></i>ç¬¬4é€±
                            </h5>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ è‡ªå‹•ç©ç«‹ã®è¨­å®š</li>
                                <li>â€¢ æœˆæ¬¡æŒ¯ã‚Šè¿”ã‚Š</li>
                                <li>â€¢ æ¬¡æœˆã®ç›®æ¨™è¨­å®š</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(plan);
        }

        function getCategoryName(key) {
            const names = {
                housing: 'ä½å±…è²»',
                food: 'é£Ÿè²»',
                utilities: 'æ°´é“å…‰ç†±è²»',
                communication: 'é€šä¿¡è²»',
                transport: 'äº¤é€šè²»',
                entertainment: 'å¨¯æ¥½è²»',
                others: 'ãã®ä»–'
            };
            return names[key] || key;
        }

        function saveToHistory(analysis) {
            let history = JSON.parse(localStorage.getItem('budgetHistory') || '[]');
            history.unshift(analysis);
            history = history.slice(0, 10); // æœ€æ–°10ä»¶ã®ã¿ä¿æŒ
            localStorage.setItem('budgetHistory', JSON.stringify(history));
            displayHistory();
        }

        function displayHistory() {
            const history = JSON.parse(localStorage.getItem('budgetHistory') || '[]');
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">ã¾ã è¨ºæ–­å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = history.map((item, index) => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-semibold">è¨ºæ–­æ—¥: ${new Date(item.timestamp).toLocaleDateString('ja-JP')}</span>
                            <span class="ml-4 text-sm text-gray-600">
                                åå…¥: Â¥${item.income.toLocaleString()}
                            </span>
                            <span class="ml-4 text-sm text-gray-600">
                                è²¯è“„ç‡: ${item.savingsRate.toFixed(1)}%
                            </span>
                        </div>
                        <button onclick="loadHistoryItem(${index})" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition-colors">
                            å†è¡¨ç¤º
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadHistoryItem(index) {
            const history = JSON.parse(localStorage.getItem('budgetHistory') || '[]');
            const item = history[index];
            if (item) {
                currentAnalysis = item;
                displayResults(item);
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function shareToTwitter() {
            if (!currentAnalysis) return;
            
            const text = `å®¶è¨ˆè¨ºæ–­çµæœğŸ“Š
        
åå…¥: Â¥${currentAnalysis.income.toLocaleString()}
è²¯è“„ç‡: ${currentAnalysis.savingsRate.toFixed(1)}%
ç¯€ç´„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«: Â¥${currentAnalysis.analysis.savingsPotential.toLocaleString()}

å®¶è¨ˆã®ç„¡é§„ãŒè¦‹ãˆã‚‹åŒ–ã§ãã¾ã—ãŸï¼
ã¿ã‚“ãªã‚‚è©¦ã—ã¦ã¿ã¦ğŸ’¡

#ç¶™ç¶šã¯åŠ›ãªã‚Š #å®¶è¨ˆè¨ºæ–­ #ç¯€ç´„è¡“ #ç„¡æ–™ãƒ„ãƒ¼ãƒ«`;
            
            const url = encodeURIComponent(window.location.href);
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}`;
            window.open(twitterUrl, '_blank');
        }

        function shareToLine() {
            if (!currentAnalysis) return;
            
            const text = `å®¶è¨ˆè¨ºæ–­ã§ç¯€ç´„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’ç™ºè¦‹ï¼
        
ç¯€ç´„å¯èƒ½é¡: Â¥${currentAnalysis.analysis.savingsPotential.toLocaleString()}/æœˆ
è²¯è“„ç‡: ${currentAnalysis.savingsRate.toFixed(1)}%

è©³ã—ã„åˆ†æçµæœã¯ã“ã¡ã‚‰ğŸ‘‡`;
            
            const url = window.location.href;
            const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
            window.open(lineUrl, '_blank');
        }

        function copyResults() {
            if (!currentAnalysis) return;
            
            const text = `ã€å®¶è¨ˆè¨ºæ–­çµæœã€‘
        
ğŸ“Š åŸºæœ¬æƒ…å ±
åå…¥: Â¥${currentAnalysis.income.toLocaleString()}
åæ”¯ãƒãƒ©ãƒ³ã‚¹: Â¥${currentAnalysis.balance.toLocaleString()}
è²¯è“„ç‡: ${currentAnalysis.savingsRate.toFixed(1)}%

ğŸ’¡ ç¯€ç´„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
Â¥${currentAnalysis.analysis.savingsPotential.toLocaleString()}/æœˆ

ğŸ¯ æ”¹å–„ææ¡ˆ
${currentAnalysis.analysis.recommendations.map(rec => 
    `${rec.category}: Â¥${rec.potentialSaving.toLocaleString()}/æœˆã®ç¯€ç´„å¯èƒ½`
).join('\n')}

è¨ºæ–­ã‚µã‚¤ãƒˆ: ${window.location.href}`;

            navigator.clipboard.writeText(text).then(() => {
                alert('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            });
        }

        // PWAå¯¾å¿œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'budget-analyzer-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl);
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            displayHistory();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—
            const inputs = ['income', 'housing', 'food', 'utilities', 'communication', 'transport', 'entertainment', 'others'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });
        });

        function updatePreview() {
            const income = parseFloat(document.getElementById('income').value) || 0;
            const totalExpenses = ['housing', 'food', 'utilities', 'communication', 'transport', 'entertainment', 'others']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);
            
            if (income > 0) {
                const balance = income - totalExpenses;
                const savingsRate = (balance / income) * 100;
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
                console.log(`Preview - Balance: Â¥${balance.toLocaleString()}, Savings Rate: ${savingsRate.toFixed(1)}%`);
            }
        }
    </script>
</body>
</html>